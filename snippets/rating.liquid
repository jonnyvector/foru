{%- comment -%}
  Priority order for rating data:
  1. Product metaobject with "Use Static Rating" = true
  2. Real review app data
  3. No reviews fallback
{%- endcomment -%}

{%- liquid
  assign rating_value = null
  assign review_count = null
  assign has_rating = false
  assign product_rating_obj = product.metafields.custom.product_rating.value

  # Check for product-level static rating metaobject
  if product_rating_obj
    assign use_data = product_rating_obj.use_review_data
    if use_data == true
      # Rating field returns an object with value property that's a string
      # We need to extract and convert it to a number
      assign rating_str = product_rating_obj.rating.value
      assign review_count = product_rating_obj.review_count
      assign has_rating = true

      # Convert string to number by splitting and rebuilding
      # For "5.0" or "4.7" we need to calculate percent directly
      if rating_str == "5.0" or rating_str == "5"
        assign percent = 100
      elsif rating_str == "4.5"
        assign percent = 90
      elsif rating_str == "4.7"
        assign percent = 94
      elsif rating_str == "4.0" or rating_str == "4"
        assign percent = 80
      elsif rating_str == "3.5"
        assign percent = 70
      elsif rating_str == "3.0" or rating_str == "3"
        assign percent = 60
      elsif rating_str == "2.5"
        assign percent = 50
      elsif rating_str == "2.0" or rating_str == "2"
        assign percent = 40
      elsif rating_str == "1.5"
        assign percent = 30
      elsif rating_str == "1.0" or rating_str == "1"
        assign percent = 20
      else
        assign percent = 0
      endif
      assign rating_value = rating_str
    endif
  endif

  # Fallback to real review app data if no metaobject rating
  if has_rating == false and reviews.rating.value != blank and reviews.rating_count != 0
    assign rating_value = reviews.rating.value.rating
    assign review_count = reviews.rating_count
    assign has_rating = true
    assign percent = rating_value | times: 20
  endif
-%}

<!-- DEBUG START -->
<!-- product_rating_obj: {{ product_rating_obj }} -->
<!-- product_rating_obj.rating: {{ product_rating_obj.rating }} -->
<!-- product_rating_obj.rating times 1: {{ product_rating_obj.rating | times: 1 }} -->
<!-- has_rating: {{ has_rating }} -->
<!-- rating_value: {{ rating_value }} -->
<!-- rating_value times 1: {{ rating_value | times: 1 }} -->
<!-- rating_as_number: {{ rating_as_number }} -->
<!-- review_count var: {{ review_count }} -->
<!-- percent: {{ percent }} -->
<!-- DEBUG END -->

<div class="wt-rating{% if text_alignment %} wt-rating--{{ text_alignment }}{% endif %} {% if settings.animations and main_product %} scroll-trigger animate--slide-in {% endif %} {% if settings.disabled_animations_on_mobile %} disabled-on-mobile {% endif %}">
  {% render 'rating-stars', percent: percent %}

  <div class="wt-rating__counter">
    {% if has_rating %}
      ({{ review_count }}
      {{ 'accessibility.total_reviews' | t -}}
      )
    {% else %}
      ({{ 'no_reviews' | t -}}
      )
    {% endif %}
  </div>
</div>
