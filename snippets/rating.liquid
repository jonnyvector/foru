{%- comment -%}
  Priority order for rating data:
  1. Product metaobject with "Use Static Rating" = true
  2. Real review app data
  3. No reviews fallback
{%- endcomment -%}

{%- liquid
  assign rating_value = null
  assign review_count = null
  assign has_rating = false
  assign product_rating_obj = product.metafields.custom.product_rating.value

  # Check for product-level static rating metaobject
  if product_rating_obj
    assign use_data = product_rating_obj.use_review_data
    if use_data == true
      # Extract the numeric value from the rating's value string by removing decimals and dividing
      assign rating_str = product_rating_obj.rating.value
      # Calculate percent directly: "5.0" -> 100, "4.7" -> 94, etc
      # Split on decimal, multiply whole number by 20, add decimal * 2
      assign rating_parts = rating_str | split: '.'
      assign whole = rating_parts[0] | times: 20
      assign decimal = rating_parts[1] | times: 2
      assign percent = whole | plus: decimal
      assign rating_value = rating_str
      assign review_count = product_rating_obj.review_count
      assign has_rating = true
    endif
  endif

  # Fallback to real review app data if no metaobject rating
  if has_rating == false and reviews.rating.value != blank and reviews.rating_count != 0
    assign rating_value = reviews.rating.value.rating
    assign review_count = reviews.rating_count
    assign has_rating = true
    assign percent = rating_value | times: 20
  endif
-%}

<!-- DEBUG START -->
<!-- rating_str: {{ rating_str }} -->
<!-- rating_parts[0]: {{ rating_parts[0] }} -->
<!-- rating_parts[1]: {{ rating_parts[1] }} -->
<!-- whole: {{ whole }} -->
<!-- decimal: {{ decimal }} -->
<!-- whole plus decimal: {{ whole | plus: decimal }} -->
<!-- percent: {{ percent }} -->
<!-- DEBUG END -->

<div class="wt-rating{% if text_alignment %} wt-rating--{{ text_alignment }}{% endif %} {% if settings.animations and main_product %} scroll-trigger animate--slide-in {% endif %} {% if settings.disabled_animations_on_mobile %} disabled-on-mobile {% endif %}">
  {% if has_rating %}
    {% render 'rating-stars', percent: percent %}
  {% endif %}

  <div class="wt-rating__counter">
    {% if has_rating %}
      ({{ review_count }}
      {{ 'accessibility.total_reviews' | t -}}
      )
    {% else %}
      ({{ 'no_reviews' | t -}}
      )
    {% endif %}
  </div>
</div>
