{% liquid
  assign products_source = section.settings.collection.products
  assign show_section = false

  if section.settings.product_list != empty
    assign products_source = section.settings.product_list
  endif

  if request.design_mode == true or section.settings.hide_empty_section == false or section.settings.hide_empty_section == true and products_source != blank
    assign show_section = true
  endif
%}

{% if show_section %}
  {%- comment -%} Load taste swatches data once for all products {%- endcomment -%}
  {% include 'taste-swatches-data' %}

  {{ 'swiper.css' | asset_url | stylesheet_tag }}

  {% assign background_rgb = section.settings.background_color | color_to_rgb %}
  {% assign text_rgb = section.settings['color-body-text'] | color_to_rgb %}

  <style>
    [data-section-id="{{ section.id }}"] {

      {% if background_rgb != 'rgba(0, 0, 0, 0.0)' %}
        --color-background: {{ section.settings.background_color }};
      {% endif %}

      {% if section.settings.margin-top %}
        --section-gap-top: {{ section.settings.margin-top }}px;
      {% endif %}

      {% if section.settings.margin-bottom %}
        --section-gap-bottom: {{ section.settings.margin-bottom }}px;
      {% endif %}

    }

    [data-section-id="{{ section.id }}"] .headline__title {
      font-size: var(--font-h5-size);
      text-transform: none;
    }

    [data-section-id="{{ section.id }}"] {
      {% if text_rgb != 'rgba(0, 0, 0, 0.0)' %}
        --color-custom-text: {{ section.settings.color-body-text }};
        --color-price: {{ section.settings.color-body-text }};
        --color-brand: {{ section.settings.color-body-text }};
        --color-star-rating: {{ section.settings.color-body-text }};
      {% endif %}
      {% if section.settings.enable_stack_products %}
        --grid-col-mobile: {{ section.settings.number_of_column_mobile | floor }};
        --grid-col: {{ section.settings.number_of_column_desktop | floor }};
        --grid-gap: {{ section.settings.spacing_desktop }}px;
      {% endif %}
      --grid-gap-mobile: {{ section.settings.spacing_mobile }}px;
    }

    [data-section-id="{{ section.id }}"] .wt-slider {
      padding-bottom: 24px;
    }

    [data-section-id="{{ section.id }}"] .wt-slider__scrollbar--featured {
      bottom: -24px !important;
    }

    [data-section-id="{{ section.id }}"] .wt-featured-collection__button-container {
      margin-top: 8px;
    }

    /* Featured collection variant font sizes - mobile: 20px, desktop: 24px */
    [data-section-id="{{ section.id }}"] .card__title,
    [data-section-id="{{ section.id }}"] .card__price,
    [data-section-id="{{ section.id }}"] .featured-variant-option-title {
      font-size: 20px;
    }

    [data-section-id="{{ section.id }}"] .featured-variant-option-title {
      opacity: 0.5;
    }

    @media (min-width: 1200px) {
      [data-section-id="{{ section.id }}"] .card__title,
      [data-section-id="{{ section.id }}"] .card__price,
      [data-section-id="{{ section.id }}"] .featured-variant-option-title {
        font-size: 24px;
      }
    }
  </style>
  {% if section.settings.enable_quick_add_button %}
    <script src="{{ 'quick-add.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'variant-dropdown.js' | asset_url }}" defer="defer"></script>
  {% endif %}

  <div data-section-id="{{ section.id }}" class="wt-featured-collection wt-slider {% if section.settings.disable_on_mobile %}wt-featured-collection--disable-on-mobile{% endif %}">
    {% if section.settings.title != blank %}
      <div class="headline {% if settings.animations %} scroll-trigger animate--slide-in {% endif %} {% if settings.disabled_animations_on_mobile %} disabled-on-mobile {% endif %} {% if section.settings.heading_disable_on_mobile == true %} hero__title--mobile{% endif %}  {% if section.settings.disable_on_mobile %}disable-on-mobile{% endif %}" style="text-align: left;">
        <h4 class="headline__title">{{ section.settings.title }}</h4>
      </div>
    {% endif %}

    <!-- Slider main container -->
    <slideshow-section class="wt-slider {% if section.settings.make_products_full_width %} wt-slider--full {% endif %}" data-slides-group>
      <div data-swiper class="wt-slider__container--featured loading  {% if section.settings.make_products_full_width %} wt-slider__container--full {% endif %}">
        <!-- Additional required wrapper -->
        <div
          data-swiper-container
          {% if section.settings.enable_stack_products %}
          class=" wt-slider__wrapper--stack {% if section.settings.number_of_column_desktop == 2%} wt-slider__wrapper--stack-2-col {% endif %}"
          {% endif %}>
          <!-- Slides -->
          {%- if products_source == blank -%}
            {% for i in (1..section.settings.products_to_show) %}
              <div
                data-swiper-slide
                {% if i < 6 and settings.animations and forloop.index <= 2 %}
                data-cascade
                class="scroll-trigger animate--slide-in {% if settings.disabled_animations_on_mobile %} disabled-on-mobile {% endif %}"
                style="--animation-order: {{ i }};"
                {% else %}
                class="wt-slider__card-wrapper"
                {% endif %}>
                {% assign placeholder_image_index = i | modulo: 4 %}
                {% if placeholder_image_index == 0 %}
                  {% assign placeholder_image_index = 1 %}
                {% endif %}
                {% render 'card'
                  , placeholder_image_index: placeholder_image_index
                  , title: 'Example product variant'
                  , subtitle: 'Vendor'
                  , price: '1999'
                  , rating: section.settings.show_product_rating
                  , options: false
                  , text_alignment: section.settings.text_alignment
                  , enable_quick_add_button: section.settings.enable_quick_add_button
                %}
              </div>
            {% endfor %}
        {%- endif -%}

          {% comment %} Loop through products and then their variants {% endcomment %}
          {%- assign variant_count = 0 -%}
          {%- for product in products_source -%}
            {%- for variant in product.variants limit: section.settings.variants_per_product -%}
              {%- if variant_count >= section.settings.products_to_show -%}
                {%- break -%}
              {%- endif -%}

              <div data-swiper-slide>
                {% comment %} Use variant featured image or product featured image {% endcomment %}
                {% assign variant_image = variant.featured_image | default: product.featured_media %}
                {% if section.settings.show_secondary_image and product.images[1] %}
                  {% assign image_hover = product.images[1] %}
                {% else %}
                  {% assign image_hover = false %}
                {% endif %}

                {%- assign variant_url = product.url | append: '?variant=' | append: variant.id -%}

                  <div
                  {% if settings.animations and variant_count <= 1 %}
                  data-cascade
                  class="scroll-trigger animate--slide-in {% if settings.disabled_animations_on_mobile %} disabled-on-mobile {% endif %}"
                  style="--animation-order: {{ variant_count | plus: 1 }};"
                  {% else %}
                  class="wt-slider__card-wrapper"
                  {% endif %}>
                  {% comment %} Combine product title and variant title with line break {% endcomment %}
                {% capture combined_title %}{{ product.title }}<br><p style="margin-top: 1.5rem; font-weight: var(--font-base-weight);" class="featured-variant-option-title">{{ variant.title }}</p>{% endcapture %}
                  {% comment %} Create a single-variant product for quick-add by overriding the available property {% endcomment %}
                  {% assign variant_as_product = product %}
                  {% render 'card', card_variant: variant, img: variant_image, img_hover: image_hover, title: combined_title, subtitle: product.vendor, rating: section.settings.show_product_rating, reviews: product.metafields.reviews, options: false, card_url: variant_url, uri: product.handle | append: '?variant=' | append: variant.id, text_alignment: section.settings.text_alignment, variants: product.variants, product_options: product.options, product: variant_as_product, card_product: product, media_aspect_ratio: section.settings.image_ratio, enable_quick_add_button: section.settings.enable_quick_add_button, show_video: section.settings.show_video, price: variant.price, compare_at_price: variant.compare_at_price, variant_context: true, taste_swatches_map_string: taste_swatches_map_string
                  %}
                </div>
              </div>
              {%- assign variant_count = variant_count | plus: 1 -%}
            {%- endfor -%}
          {%- endfor -%}
        </div>

        {% unless section.settings.enable_stack_products %}
          <!-- Add Arrows -->
          <div class="swiper-button-next wt-slider__nav-btn wt-slider__nav-next wt-slider__nav-next--featured">
            {% render 'icons'
              , id: 'arrow-right' %}
          </div>
          <div class="swiper-button-prev wt-slider__nav-btn wt-slider__nav-prev wt-slider__nav-prev--featured">
            {% render 'icons'
              , id: 'arrow-left' %}
          </div>

          <!-- If we need scrollbar -->
          <div class="swiper-scrollbar wt-slider__scrollbar wt-slider__scrollbar--featured {% if section.settings.make_products_full_width %} wt-slider__scrollbar--full {% endif %}"></div>
        {% endunless %}


        <script data-swiper-configuration type="text/json">
          {
            "enabled": {% unless section.settings.enable_stack_products %}true{% else %}false{% endunless %},
            "slidesPerView": "auto",
            "freeMode": false,
            "centeredSlides": false,
            "slideToClickedSlide": false,
            "centeredSlidesBounds": true,
            "speed": 150,
            "grabCursor": false,
            "paginationType": "bullets",
            {% unless section.settings.enable_stack_products %}
            "breakpoints": {
              "320": {
                "slidesPerView": {{ section.settings.number_of_column_mobile }},
                "slidesPerGroup": {{ section.settings.number_of_column_mobile | floor }},
                "spaceBetween": {{ section.settings.spacing_mobile | floor }}
              },
              "900": {
                "slidesPerView": {{ section.settings.number_of_column_desktop }},
                "slidesPerGroup": {{ section.settings.number_of_column_desktop | floor }},
                "spaceBetween": {{ section.settings.spacing_desktop | floor }}
              }
            },
            "navigation": {
              "nextEl": ".wt-slider__nav-next--featured",
              "prevEl": ".wt-slider__nav-prev--featured"
            },
            "scrollbar": {
              "el": ".wt-slider__scrollbar--featured",
              "draggable": true
            },
          {% endunless %}
            "pagination": false
          }
        </script>
      </div>
  </slideshow-section>

    {%- comment -%} Calculate total available variants {%- endcomment -%}
    {%- assign total_variants = 0 -%}
    {%- for product in products_source -%}
      {%- assign product_variants = product.variants | size -%}
      {%- if product_variants > section.settings.variants_per_product -%}
        {%- assign total_variants = total_variants | plus: section.settings.variants_per_product -%}
      {%- else -%}
        {%- assign total_variants = total_variants | plus: product_variants -%}
      {%- endif -%}
    {%- endfor -%}

    {% if section.settings.show_view_all and total_variants > section.settings.products_to_show and section.settings.product_list == empty
    %}
      <div class="wt-featured-collection__button-container wt-button__container">
        {% assign collection_url = routes.collections_url | append: '/' | append: section.settings.collection.handle %}
        {% render 'custom-view-all', text: 'View all', url: collection_url, aria_label: 'View all', id: section.id | append: '-view-all'
        %}
      </div>
    {% endif %}
  </div>
{% endif %}

{% schema %}
  {
    "name": "Collection Variants",
    "tag": "section",
    "class": "spaced-section",
    "settings": [
      {
        "type": "textarea",
        "id": "title",
        "default": "Featured variants",
        "label": "Section title"
      },
      {
        "type": "checkbox",
        "id": "disable_on_mobile",
        "label": "t:sections.global.disable_on_mobile",
        "default": false
      },
      {
        "type": "checkbox",
        "id": "hide_empty_section",
        "label": "t:sections.featured-collection.settings.hide_empty_section.label",
        "info": "t:sections.featured-collection.settings.hide_empty_section.info",
        "default": false
      },
      {
        "type": "collection",
        "id": "collection",
        "label": "Collection"
      }, {
        "type": "product_list",
        "id": "product_list",
        "label": "t:sections.featured-collection.settings.products.label",
        "info": "t:sections.featured-collection.settings.products.info"
      }, {
        "type": "range",
        "id": "products_to_show",
        "min": 3,
        "max": 24,
        "step": 1,
        "default": 8,
        "label": "Total variants to show"
      }, {
        "type": "range",
        "id": "variants_per_product",
        "min": 1,
        "max": 10,
        "step": 1,
        "default": 3,
        "label": "Max variants per product"
      }, {
        "type": "checkbox",
        "id": "enable_stack_products",
        "default": false,
        "label": "t:sections.featured-collection.settings.enable_stack_products.label"
      }, {
        "type": "checkbox",
        "id": "show_view_all",
        "default": true,
        "label": "t:sections.featured-collection.settings.show_view_all.label"
      }, {
        "type": "select",
        "id": "button_select",
        "options": [
          {
            "value": "primary",
            "label": "t:sections.settings.settings.button_select.primary.label"
          }, {
            "value": "secondary",
            "label": "t:sections.settings.settings.button_select.secondary.label"
          }, {
            "value": "link",
            "label": "t:sections.settings.settings.button_select.link.label"
          }
        ],
        "default": "primary",
        "label": "t:sections.featured-collection.settings.button_select.label"
      }, {
        "type": "header",
        "content": "t:sections.global.desktop_version"
      }, {
        "type": "range",
        "id": "number_of_column_desktop",
        "min": 2,
        "max": 5,
        "step": 1,
        "default": 4,
        "label": "t:sections.featured-collection.settings.number_of_column_desktop.label"
      }, {
        "type": "select",
        "id": "spacing_desktop",
        "options": [
          {
            "value": "8",
            "label": "t:sections.main-collection-product-grid.settings.spacing_desktop.1.label"
          }, {
            "value": "16",
            "label": "t:sections.main-collection-product-grid.settings.spacing_desktop.2.label"
          }, {
            "value": "24",
            "label": "t:sections.main-collection-product-grid.settings.spacing_desktop.3.label"
          }
        ],
        "default": "16",
        "label": "t:sections.main-collection-product-grid.settings.spacing_desktop.label"
      }, {
        "type": "checkbox",
        "id": "make_products_full_width",
        "default": true,
        "label": "t:sections.featured-collection.settings.make_products_full_width.label"
      }, {
        "type": "header",
        "content": "t:sections.global.mobile_version"
      }, {
        "type": "range",
        "id": "number_of_column_mobile",
        "min": 1.1,
        "max": 2.5,
        "step": 0.1,
        "default": 2.1,
        "label": "t:sections.featured-collection.settings.number_of_column_mobile.label"
      }, {
        "type": "select",
        "id": "spacing_mobile",
        "options": [
          {
            "value": "4",
            "label": "4px"
          }, {
            "value": "8",
            "label": "8px"
          }, {
            "value": "12",
            "label": "12px"
          }, {
            "value": "16",
            "label": "16px"
          }
        ],
        "default": "16",
        "label": "t:sections.featured-collection.settings.spacing_mobile.label"
      }, {
        "type": "header",
        "content": "t:sections.main-collection-product-grid.settings.header__3.content"
      }, {
        "type": "select",
        "id": "text_alignment",
        "options": [
          {
            "value": "center",
            "label": "t:sections.featured-collection.settings.text_alignment.center.label"
          }, {
            "value": "left",
            "label": "t:sections.featured-collection.settings.text_alignment.left.label"
          }
        ],
        "default": "left",
        "label": "t:sections.featured-collection.settings.text_alignment.label"
      }, {
        "type": "select",
        "id": "image_ratio",
        "options": [
          {
            "value": "adapt",
            "label": "t:sections.featured-collection.settings.image_ratio.options__1.label"
          }, {
            "value": "portrait",
            "label": "t:sections.featured-collection.settings.image_ratio.options__2.label"
          }, {
            "value": "square",
            "label": "t:sections.featured-collection.settings.image_ratio.options__3.label"
          }
        ],
        "default": "square",
        "label": "t:sections.featured-collection.settings.image_ratio.label"
      }, {
        "type": "checkbox",
        "id": "show_video",
        "default": false,
        "label": "t:sections.main-collection-product-grid.settings.show_video.label",
        "info": "t:sections.main-collection-product-grid.settings.show_video.info"
      }, {
        "type": "checkbox",
        "id": "show_secondary_image",
        "default": false,
        "label": "t:sections.featured-collection.settings.show_secondary_image.label"
      }, {
        "type": "checkbox",
        "id": "show_vendor",
        "default": true,
        "label": "t:sections.featured-collection.settings.show_vendor.label"
      }, {
        "type": "checkbox",
        "id": "show_product_rating",
        "default": true,
        "label": "t:sections.featured-collection.settings.show_product_rating.label",
        "info": "t:sections.featured-collection.settings.show_product_rating.info"
      }, {
        "type": "checkbox",
        "id": "enable_quick_add_button",
        "default": false,
        "label": "t:sections.featured-collection.settings.enable_quick_add_button.label",
        "info": "t:sections.featured-collection.settings.enable_quick_add_button.info"
      }, {
        "type": "header",
        "content": "t:sections.global.colors",
        "info": "t:sections.global.colors-info"
      }, {
        "type": "color",
        "id": "color-body-text",
        "default": "transparent",
        "label": "t:sections.settings.settings.text-color.label"
      }, {
        "type": "color",
        "id": "background_color",
        "default": "transparent",
        "label": "t:sections.settings.settings.background-color.label"
      }, {
        "type": "header",
        "content": "t:sections.global.section_spacing"
      }, {
        "type": "range",
        "id": "margin-top",
        "min": 0,
        "max": 100,
        "unit": "px",
        "step": 4,
        "default": 20,
        "label": "t:sections.rich-text.settings.top_distance.label"
      }, {
        "type": "range",
        "id": "margin-bottom",
        "min": 0,
        "max": 100,
        "unit": "px",
        "step": 4,
        "default": 20,
        "label": "t:sections.rich-text.settings.bottom_distance.label",
        "info": "t:sections.separator.settings.separator-bottom.info"
      }
    ],
    "presets": [
      {
        "name": "Collection Variants"
      }
    ],
    "disabled_on": {
      "groups": ["header", "footer"]
    }
  }
{% endschema %}